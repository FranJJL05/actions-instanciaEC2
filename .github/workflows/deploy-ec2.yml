# .github/workflows/deploy-ec2.yml
name: Despliegue CI/CD a EC2 con Nginx

on:
  push:
    branches:
      - feature/despliegue-ec2
  workflow_dispatch:

jobs:
  pruebas-y-despliegue: 
    runs-on: ubuntu-latest 
    steps:
      - name: 1. Checkout del proyecto
        uses: actions/checkout@v5.0.0
      
      - name: 2. Configurar Node.js
        uses: actions/setup-node@v6.0.0
        with:
          node-version: '20.x'

      - name: 3. Instalar dependencias (Mocha y JSDoc)
        run: npm install 

      # --- INTEGRACIÓN CONTINUA (CI) ---
      
      # 4. Forzar Permisos de Ejecución (Mocha/JSDoc)
      - name: 4. Forzar Permisos de Ejecución
        run: |
          chmod +x ./node_modules/.bin/mocha
          chmod +x ./node_modules/.bin/jsdoc

      - name: 5. Ejecutar las pruebas con Mocha
        run: node --experimental-modules node_modules/mocha/bin/mocha test/pruebas.test.js
      
      - name: 6. Generar la documentacion (JSDoc)
        run: npx jsdoc src/js/index.js -d docs 

      # --- PASO CRÍTICO: PREPARACIÓN PARA DESPLIEGUE (BUILD STEP) ---
      # ESTE PASO MUEVE index.html y sus carpetas (css/ y js/) a la raíz del repositorio
      # Esto elimina la carpeta 'src/' de la ruta final del servidor, SOLUCIONANDO el 404.
      - name: 6.5. Preparar Archivos de Despliegue (Mover contenido de 'src' a la raíz)
        run: |
          # Copia el contenido de 'src' (index.html, css/, js/) a la raíz del repositorio.
          cp -r src/* .
          # Eliminar carpetas grandes para no subirlas al servidor y ahorrar tiempo.
          rm -rf src
          rm -rf node_modules 
      # --- FIN PASO CRÍTICO ---


      # --- DESPLIEGUE CONTINUO (CD) ---
      
      - name: 7. Instalar Nginx, Crear Directorio Remoto y Ajustar Permisos (SSH)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }} 
          script: |
            # Instalación de Nginx
            sudo apt update
            sudo apt install nginx -y
            sudo mkdir -p /etc/nginx/sites-available
            
            # Crear el directorio de la aplicación si no existe
            sudo mkdir -p /var/www/html/app-deploy 
            # Darle propiedad del directorio al usuario para que SCP pueda escribir
            sudo chown -R ${{ secrets.USERNAME }}:www-data /var/www/html/app-deploy
            # CRÍTICO: Asegurar permisos de LECTURA (755) para el grupo www-data (Nginx)
            sudo chmod -R 755 /var/www/html/app-deploy

      - name: 8. Subir Archivos a EC2 (SCP)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          # Copia el contenido de la raíz, donde ahora están los archivos planos (index.html).
          source: "./*" 
          target: "/var/www/html/app-deploy"
          overwrite: true 
          command_timeout: 10m

      - name: 9. Configurar Nginx para /app-deploy/ (SSH)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          script: |
            # Definición de la configuración de Nginx.
            NGINX_CONF="server {
                listen 80;
                server_name _; 
                location /app-deploy/ {
                    # SOLUCIÓN: El alias apunta a la raíz del despliegue, ¡sin 'src/'!
                    alias /var/www/html/app-deploy/; 
                    index index.html;
                    try_files \$uri \$uri/ =404;
                }
            }"
            # Escribir la configuración en el archivo remoto, asegurando permisos con 'tee'
            echo "$NGINX_CONF" | sudo tee /etc/nginx/sites-available/app-deploy

      - name: 10. Habilitar y Reiniciar Nginx (SSH)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          script: |
            # 1. Quitar el enlace simbólico 'default' que podría estar activo.
            sudo rm -f /etc/nginx/sites-enabled/default
            # 2. Crear un nuevo enlace simbólico para nuestra app en sites-enabled.
            sudo ln -s /etc/nginx/sites-available/app-deploy /etc/nginx/sites-enabled/app-deploy
            # 3. Verificar configuración y reiniciar el servicio
            sudo nginx -t
            sudo systemctl restart nginx

      # --- VERIFICACIÓN FINAL ---
      - name: 11. Verificar que la aplicación está visible
        run: |
          echo "Verificando host: ${{ secrets.EC2_HOST }}"
          # Si Nginx devuelve 200 OK, la prueba es exitosa.
          curl -f -s -S http://${{ secrets.EC2_HOST }}/app-deploy/index.html | grep 'HTTP/1.1 200 OK'


      