name: Despliegue CI/CD a EC2 con Nginx

on:
  push:
    branches:
      - feature/despliegue-ec2
  workflow_dispatch:

jobs:
  despliegue:
    runs-on: ubuntu-latest
    steps:

      # --- 1. Preparar proyecto ---
      - name: Checkout del proyecto
        uses: actions/checkout@v5.0.0

      - name: Configurar Node.js
        uses: actions/setup-node@v6.0.0
        with:
          node-version: '20.x'

      - name: Instalar dependencias
        run: npm install

      - name: Forzar permisos de ejecución
        run: |
          chmod +x ./node_modules/.bin/mocha
          chmod +x ./node_modules/.bin/jsdoc

      - name: Ejecutar pruebas
        run: node --experimental-modules node_modules/mocha/bin/mocha test/pruebas.test.js

      - name: Generar documentación
        run: npx jsdoc js/index.js -d docs

      - name: Asegurar carpeta docs
        run: |
          mkdir -p docs
          touch docs/.keep  # evita que SCP falle si está vacía

      - name: Listar archivos antes de subir
        run: ls -R

      # --- 2. Preparar EC2 e instalar Nginx ---
      - name: Instalar Nginx y preparar directorio
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          script: |
            sudo apt update
            sudo apt install nginx -y
            sudo mkdir -p /var/www/html
            sudo chown -R ${{ secrets.USERNAME }}:www-data /var/www/html
            sudo chmod -R 755 /var/www/html

      # --- 3. Subir aplicación y docs ---
      - name: Subir archivos a EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          source: |
            ./index.html
            ./styles.css
            ./js/*
            ./docs/*
          target: "/var/www/html"
          overwrite: true
          command_timeout: 10m

      # --- 4. Configurar Nginx ---
      - name: Configurar Nginx y reiniciar
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          script: |
            NGINX_CONF="server {
                listen 80;
                server_name _;
                root /var/www/html;
                index index.html;
            }"
            echo "$NGINX_CONF" | sudo tee /etc/nginx/sites-available/default
            sudo nginx -t
            sudo systemctl restart nginx
            echo "✅ Nginx configurado y reiniciado"

      # --- 5. Verificación final ---
      - name: Verificar despliegue
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}/index.html || echo "000")
          echo "Código HTTP recibido: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "❌ La aplicación no responde correctamente."
            curl -v http://${{ secrets.EC2_HOST }}/index.html || true
            exit 1
          fi
          echo "✅ La aplicación está accesible correctamente (HTTP 200)"
