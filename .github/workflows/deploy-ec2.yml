# .github/workflows/deploy-ec2.yml
name: Despliegue CI/CD a EC2 con Nginx

on:
  push:
    branches:
      - feature/despliegue-ec2
  workflow_dispatch:

jobs:
  pruebas-y-despliegue: 
    runs-on: ubuntu-latest 
    steps:
      - name: 1. Checkout del proyecto
        uses: actions/checkout@v5.0.0
      
      - name: 2. Configurar Node.js
        uses: actions/setup-node@v6.0.0
        with:
          node-version: '14.x'

      - name: 3. Instalar dependencias (Mocha y JSDoc)
        run: npm install 

      # --- INTEGRACIÓN CONTINUA (CI) ---
      
      # 4. Forzar Permisos de Ejecución (Mocha/JSDoc)
      - name: 4. Forzar Permisos de Ejecución
        run: |
          chmod +x ./node_modules/.bin/mocha
          chmod +x ./node_modules/.bin/jsdoc

      - name: 5. Ejecutar las pruebas con Mocha
        run: NODE_OPTIONS='--no-warnings' npx mocha --loader /dev/null test/pruebas.test.js
      
      - name: 6. Generar la documentacion (JSDoc)
        run: npx jsdoc src/js/index.js -d docs 

      # --- DESPLIEGUE CONTINUO (CD) ---
      
      # 7. Despliegue vía SSH/SCP (Copia de archivos a EC2)
      - name: 7. Desplegar Archivos a EC2 (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          # Credenciales SSH
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          # Archivos a copiar
          source: "src/, docs/" 
          # Directorio de destino
          target: /var/www/html/app-deploy 

      # 8. Configurar Nginx y Reiniciar el servicio (Conexión SSH para comandos)
      - name: 8. Configurar Nginx para servir la ruta /app-deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            # 1. Crear el bloque de configuración de alias para Nginx
            echo '
              location /app-deploy/ {
                alias /var/www/html/app-deploy/;
                index index.html index.htm;
                try_files $uri $uri/ =404;
              }
            ' | sudo tee /etc/nginx/sites-available/app-config 
            
            # 2. Habilitar la configuración (enlace simbólico)
            sudo ln -sf /etc/nginx/sites-available/app-config /etc/nginx/sites-enabled/default 
            
            # 3. Probar la configuración de Nginx y reiniciar
            sudo nginx -t
            sudo systemctl restart nginx
          
      # 9. Comprobación final (Verifica el código 200 OK)
      - name: 9. Verificar que la aplicación está visible
        run: |
          curl -sI http://${{ secrets.EC2_HOST }}/app-deploy/index.html | grep 'HTTP/1.1 200 OK'